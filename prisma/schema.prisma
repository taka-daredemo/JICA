// Datasource & Generator
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserStatus {
  Active
  Inactive
}

enum TaskStatus {
  NotStarted
  InProgress
  Completed
  Overdue
}

enum TaskPriority {
  Critical
  High
  Medium
  Low
}

enum PermissionLevel {
  full
  edit
  view
  none
}

enum RecurrencePatternType {
  daily
  weekly
  monthly
  custom
}

enum RecurrenceEndCondition {
  never
  after
  onDate
}

enum TrainingStatus {
  Upcoming
  Completed
  Cancelled
}

enum PaymentStatus {
  Scheduled
  Pending
  Paid
  Overdue
}

// 1. User
model User {
  id            String         @id @default(uuid()) @db.Uuid
  email         String         @unique
  name          String
  avatarUrl     String?
  status        UserStatus     @default(Active)
  passwordHash  String?

  // relations
  roles         UserRole[]
  tasksAssigned Task[]         @relation("TaskAssignee")
  tasksCreated  Task[]         @relation("TaskCreator")
  taskComments  TaskComment[]
  trainings     Training[]     @relation("TrainingFacilitator")
  paymentPlans  PaymentPlan[]  @relation("PlanCreator")
  expenses      Expense[]      @relation("ExpenseCreator")

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([status])
}

// 2. Role
model Role {
  id          String        @id @default(uuid()) @db.Uuid
  name        String        @unique
  users       UserRole[]
  permissions Permission[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// 3. UserRole (junction)
model UserRole {
  userId String @db.Uuid
  roleId String @db.Uuid

  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])

  createdAt DateTime @default(now())

  @@id([userId, roleId])
  @@index([roleId])
}

// 4. Module
model Module {
  id          String        @id @default(uuid()) @db.Uuid
  name        String        @unique
  permissions Permission[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// 5. Permission (role x module)
model Permission {
  id        String          @id @default(uuid()) @db.Uuid
  roleId    String          @db.Uuid
  moduleId  String          @db.Uuid
  level     PermissionLevel

  role      Role            @relation(fields: [roleId], references: [id])
  module    Module          @relation(fields: [moduleId], references: [id])

  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([roleId, moduleId])
  @@index([moduleId])
}

// 6. Task
model Task {
  id                  String              @id @default(uuid()) @db.Uuid
  name                String
  description         String?
  assigneeId          String?             @db.Uuid
  dueDate             DateTime
  status              TaskStatus          @default(NotStarted)
  priority            TaskPriority        @default(Medium)
  isRecurring         Boolean             @default(false)
  parentTaskId        String?             @db.Uuid
  createdById         String?             @db.Uuid

  assignee            User?               @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator             User?               @relation("TaskCreator", fields: [createdById], references: [id])
  parentTask          Task?               @relation("TaskParent", fields: [parentTaskId], references: [id])
  childTasks          Task[]              @relation("TaskParent")
  comments            TaskComment[]
  recurringPattern    RecurringPattern?

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([assigneeId])
  @@index([dueDate])
  @@index([status])
  @@index([priority])
}

// 7. TaskComment
model TaskComment {
  id        String   @id @default(uuid()) @db.Uuid
  taskId    String   @db.Uuid
  authorId  String   @db.Uuid
  text      String

  task      Task     @relation(fields: [taskId], references: [id])
  author    User     @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([authorId])
}

// 8. RecurringPattern (1:1 Task)
model RecurringPattern {
  id             String                 @id @default(uuid()) @db.Uuid
  taskId         String                 @unique @db.Uuid
  pattern        RecurrencePatternType
  interval       Int                    @default(1)
  daysOfWeek     Int[]                  @default([])
  endCondition   RecurrenceEndCondition @default(never)
  occurrences    Int?
  endDate        DateTime?

  task           Task                   @relation(fields: [taskId], references: [id])

  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
}

// 9. Budget (category)
model Budget {
  id           String        @id @default(uuid()) @db.Uuid
  name         String
  totalBudget  Decimal       @db.Decimal(12, 2)
  fiscalYear   Int

  paymentPlans PaymentPlan[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([fiscalYear])
}

// 10. PaymentPlan
model PaymentPlan {
  id          String        @id @default(uuid()) @db.Uuid
  planName    String
  budgetId    String?       @db.Uuid
  amount      Decimal       @db.Decimal(12, 2)
  dueDate     DateTime
  description String?
  vendor      String?
  status      PaymentStatus @default(Scheduled)
  createdById String?       @db.Uuid

  budget      Budget?       @relation(fields: [budgetId], references: [id])
  createdBy   User?         @relation("PlanCreator", fields: [createdById], references: [id])
  expenses    Expense[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([budgetId])
  @@index([status])
}

// 11. Expense (payment)
model Expense {
  id             String    @id @default(uuid()) @db.Uuid
  planId         String?   @db.Uuid
  amount         Decimal   @db.Decimal(12, 2)
  paymentDate    DateTime
  paymentMethod  String?
  vendor         String?
  description    String?
  receiptFilename String?
  receiptUrl     String?
  notes          String?
  createdById    String?   @db.Uuid

  plan           PaymentPlan? @relation(fields: [planId], references: [id])
  createdBy      User?        @relation("ExpenseCreator", fields: [createdById], references: [id])

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([planId])
  @@index([paymentDate])
}

// 12. Farmer
model Farmer {
  id                 String   @id @default(uuid()) @db.Uuid
  farmerCode         String   @unique
  name               String
  location           String?
  contactPhone       String?
  contactEmail       String?
  landSizeHectares   Decimal? @db.Decimal(8, 2)
  yearGroup          Int?
  status             String?  @default("Active")
  baselineIncome     Decimal? @db.Decimal(12, 2)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([yearGroup])
}

// 13. Training (session)
model Training {
  id            String         @id @default(uuid()) @db.Uuid
  topic         String
  description   String?
  date          DateTime
  location      String?
  facilitatorId String?        @db.Uuid
  capacity      Int?
  status        TrainingStatus @default(Upcoming)

  facilitator   User?          @relation("TrainingFacilitator", fields: [facilitatorId], references: [id])

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([date])
  @@index([facilitatorId])
}


